---
import { getCollection } from "astro:content";
import DiagramTerminal from "./components/DiagramTerminal.astro";
import DiagramInfo from "./components/DiagramInfo.astro";
import CloudDiagram from "./components/CloudDiagram.astro";
import SequenceDiagram from "./components/SequenceDiagram.astro";
import SecurityDiagram from "./components/SecurityDiagram.astro";

const diagrams = await getCollection("architecture");

// Map diagramType to contextual icon & color
const diagramMeta: Record<
    string,
    { icon: string; color: string; statusLabel: string }
> = {
    cloud: { icon: "‚òÅ", color: "text-sky-400", statusLabel: "CLUSTER ONLINE" },
    sequence: {
        icon: "‚áÑ",
        color: "text-amber-400",
        statusLabel: "API GATEWAY ACTIVE",
    },
    security: {
        icon: "üõ°",
        color: "text-brand-accent",
        statusLabel: "ALL LAYERS SECURE",
    },
    flowchart: {
        icon: "‚äû",
        color: "text-purple-400",
        statusLabel: "PIPELINE RUNNING",
    },
    er: { icon: "‚óà", color: "text-pink-400", statusLabel: "SCHEMA SYNCED" },
};
---

<section class="py-20 bg-brand-dark relative overflow-hidden">
    <!-- Subtle grid background -->
    <div
        class="absolute inset-0 bg-[linear-gradient(rgba(16,185,129,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.03)_1px,transparent_1px)] bg-[size:40px_40px]"
    >
    </div>

    <div class="container mx-auto px-4 relative z-10">
        <!-- Section header -->
        <div class="text-center mb-20">
            <span
                class="text-brand-accent font-bold tracking-widest uppercase text-xs"
                >Diagramas del Sistema</span
            >
            <h2
                class="text-3xl md:text-5xl font-bold text-white mt-4 tracking-tight"
            >
                Arquitectura en Detalle
            </h2>
            <p class="text-gray-400 mt-4 max-w-2xl mx-auto font-light text-lg">
                Cada m√≥dulo dise√±ado para m√°xima resiliencia, seguridad y
                rendimiento.
            </p>
        </div>

        <!-- Diagrams -->
        <div class="space-y-28">
            {
                diagrams.map((diagram, index) => {
                    const meta =
                        diagramMeta[diagram.data.diagramType] ||
                        diagramMeta.cloud;
                    const isReversed = index % 2 !== 0;

                    return (
                        <div
                            class={`flex flex-col ${isReversed ? "lg:flex-row-reverse" : "lg:flex-row"} items-center gap-12 lg:gap-20`}
                        >
                            {/* Terminal Window with CSS Diagram */}
                            <div class="lg:w-7/12 w-full">
                                <DiagramTerminal
                                    title={diagram.data.title}
                                    statusLabel={meta.statusLabel}
                                    diagramType={diagram.data.diagramType}
                                    specs={diagram.data.specs}
                                >
                                    {diagram.data.diagramType === "cloud" && (
                                        <CloudDiagram />
                                    )}
                                    {diagram.data.diagramType ===
                                        "sequence" && <SequenceDiagram />}
                                    {diagram.data.diagramType ===
                                        "security" && <SecurityDiagram />}
                                </DiagramTerminal>
                            </div>

                            {/* Content Side */}
                            <div class="lg:w-5/12 w-full">
                                <DiagramInfo
                                    icon={meta.icon}
                                    color={meta.color}
                                    diagramType={diagram.data.diagramType}
                                    title={diagram.data.title}
                                    description={diagram.data.description}
                                    specs={diagram.data.specs}
                                />
                            </div>
                        </div>
                    );
                })
            }
        </div>
    </div>
</section>
